<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>rpkg-tricks – DJM</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<link href="../assets/img/djm.ico" rel="icon">
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-e1a5c8363afafaef2c763b6775fbf3ca.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-b6a1060ae9ed3a724b05dd098192097a.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-25YNZL7ZML"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-25YNZL7ZML', { 'anonymize_ip': true});
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">


<link rel="stylesheet" href="../assets/styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-md " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../assets/img/djm.png" alt="DJM" class="navbar-logo">
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../biography.html"> 
<span class="menu-text">BIOGRAPHY</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../research/index.html"> 
<span class="menu-text">RESEARCH</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../teaching/index.html"> 
<span class="menu-text">TEACHING</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../students/index.html"> 
<span class="menu-text">STUDENTS</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../other/index.html"> 
<span class="menu-text">OTHER</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#tricks-and-best-practices-for-writing-r-packages" id="toc-tricks-and-best-practices-for-writing-r-packages" class="nav-link active" data-scroll-target="#tricks-and-best-practices-for-writing-r-packages">Tricks and best-practices for writing R packages</a>
  <ul class="collapse">
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#commands-to-issue-now-or-later-but-likely-only-once" id="toc-commands-to-issue-now-or-later-but-likely-only-once" class="nav-link" data-scroll-target="#commands-to-issue-now-or-later-but-likely-only-once">Commands to issue (now or later, but likely only once)</a>
  <ul class="collapse">
  <li><a href="#usethisuse_readme_rmd" id="toc-usethisuse_readme_rmd" class="nav-link" data-scroll-target="#usethisuse_readme_rmd"><code>usethis::use_readme_rmd()</code></a></li>
  <li><a href="#usethisuse_pkgdown_github_pages" id="toc-usethisuse_pkgdown_github_pages" class="nav-link" data-scroll-target="#usethisuse_pkgdown_github_pages"><code>usethis::use_pkgdown_github_pages()</code></a></li>
  <li><a href="#usethisuse_testthat" id="toc-usethisuse_testthat" class="nav-link" data-scroll-target="#usethisuse_testthat"><code>usethis::use_testthat()</code></a></li>
  <li><a href="#usethisuse_github_actioncheck-release" id="toc-usethisuse_github_actioncheck-release" class="nav-link" data-scroll-target="#usethisuse_github_actioncheck-release"><code>usethis::use_github_action("check-release")</code></a></li>
  </ul></li>
  <li><a href="#commands-to-issue-regularly" id="toc-commands-to-issue-regularly" class="nav-link" data-scroll-target="#commands-to-issue-regularly">Commands to issue regularly</a>
  <ul class="collapse">
  <li><a href="#devtoolsload_all" id="toc-devtoolsload_all" class="nav-link" data-scroll-target="#devtoolsload_all"><code>devtools::load_all()</code></a></li>
  <li><a href="#devtoolsdocument" id="toc-devtoolsdocument" class="nav-link" data-scroll-target="#devtoolsdocument"><code>devtools::document()</code></a></li>
  <li><a href="#devtoolscheck" id="toc-devtoolscheck" class="nav-link" data-scroll-target="#devtoolscheck"><code>devtools::check()</code></a></li>
  <li><a href="#usethisuse_testname_of_function" id="toc-usethisuse_testname_of_function" class="nav-link" data-scroll-target="#usethisuse_testname_of_function"><code>usethis::use_test("name_of_function")</code></a></li>
  <li><a href="#usethisuse_tidy_description" id="toc-usethisuse_tidy_description" class="nav-link" data-scroll-target="#usethisuse_tidy_description"><code>usethis::use_tidy_description()</code></a></li>
  <li><a href="#usethisuse_vignette" id="toc-usethisuse_vignette" class="nav-link" data-scroll-target="#usethisuse_vignette"><code>usethis::use_vignette()</code></a></li>
  </ul></li>
  <li><a href="#other-idiosyncracies" id="toc-other-idiosyncracies" class="nav-link" data-scroll-target="#other-idiosyncracies">Other idiosyncracies</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"></header>




<section id="tricks-and-best-practices-for-writing-r-packages" class="level1">
<h1>Tricks and best-practices for writing R packages</h1>
<p>This document is intended to contain a few suggestions for making the writing of R packages easier. Much of it is based on resources elsewhere, especially <a href="https://r-pkgs.org" class="uri">https://r-pkgs.org</a>.</p>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>We presume you’re using GitHub for version control. You should. Do it.</p>
<p>We also presume that you’ll use RStudio for most of the development. This is much easier than VScode or Emacs, at least initially.</p>
<p>You need 5 R packages:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="fu">c</span>(<span class="st">"devtools"</span>, <span class="st">"roxygen2"</span>, <span class="st">"testthat"</span>, <span class="st">"knitr"</span> <span class="st">"usethis"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Below (and in my own workflow), I generally use the syntax <code>pkgname::function()</code> to be clear where the function lives. I prefer <em>not</em> to call, e.g., <code>library(usethis)</code> while writing a package. It’s not so much typing as to be bothersome.</p>
</div>
</div>
<ol type="1">
<li>Create a new repo on GitHub (empty).</li>
<li>Choose a location for your package (on your machine). It should not be nested inside an existing Rproject or Git repo.</li>
<li>In RStudio, navigate to the Directory where it will live, and run <code>usethis::create_package("mypkg")</code> (replacing <code>"mypkg"</code> with whatever you want to name your package). This will create a skeleton with the appropriate structure.</li>
<li>If you will be using compiled code (<code>{Rcpp}</code> for example), call <code>usethis::use_rcpp()</code> (or the <code>usethis::use_rcpp_*()</code> versions for Armadillo or Eigen).</li>
<li>Finally, init your Git, commit with some message, and push to your new repo.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>After the first two steps above, it’s worth considering whether you can use Jacob Bien’s <a href="https://jacobbien.github.io/litr-project/"><code>{litr}</code></a> package to create the entire package from a literate Rmarkdown file.</p>
</div>
</div>
</section>
<section id="commands-to-issue-now-or-later-but-likely-only-once" class="level2">
<h2 class="anchored" data-anchor-id="commands-to-issue-now-or-later-but-likely-only-once">Commands to issue (now or later, but likely only once)</h2>
<p>There are a number of useful tricks in <code>{usethis}</code> that you may want to run now. These can also be run “down the line” when you already have a working package, but at that point, you’ll likely need to make some adjustments (if some other documents already exist or similar).</p>
<section id="usethisuse_readme_rmd" class="level3">
<h3 class="anchored" data-anchor-id="usethisuse_readme_rmd"><code>usethis::use_readme_rmd()</code></h3>
<p>This creates an Rmarkdown README file that renders to the actual README. This is usually what you want to demonstrate the package. Once done, edit the README.Rmd and run <code>devtools::build_readme()</code> to render it. Don’t just click <code>Knit</code>. This may fail for a few reasons.</p>
</section>
<section id="usethisuse_pkgdown_github_pages" class="level3">
<h3 class="anchored" data-anchor-id="usethisuse_pkgdown_github_pages"><code>usethis::use_pkgdown_github_pages()</code></h3>
<p>This does a lot of things at once:</p>
<ol type="1">
<li>Automatically sets up <code>{pkgdown}</code> to render website documentation</li>
<li>Creates a GitHub action that <strong>automatically</strong> builds your site when you push to the <code>main</code> branch.</li>
<li>Puts the site on an orphan <code>gh_pages</code> branch (and tells GitHub it’s there). You no longer have that <code>docs/</code> folder sitting in your repo.</li>
<li>Adds stuff to various files to make this all work.</li>
</ol>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p>I strongly recommend doing this rather than the usual workflow that involves rebuilding the site yourself.</p>
</div>
</div>
</section>
<section id="usethisuse_testthat" class="level3">
<h3 class="anchored" data-anchor-id="usethisuse_testthat"><code>usethis::use_testthat()</code></h3>
<p>Set up unit testing for your package. You should unit test your package. Don’t do this some other way. See <a href="http://testthat.r-lib.org/" class="uri">http://testthat.r-lib.org/</a> for examples of writing complicated tests.</p>
</section>
<section id="usethisuse_github_actioncheck-release" class="level3">
<h3 class="anchored" data-anchor-id="usethisuse_github_actioncheck-release"><code>usethis::use_github_action("check-release")</code></h3>
<p>Initializes “Continuous integration” through GitHub actions. Essentially, whenever you push to <code>main</code> (or open a PR against <code>main</code>), in the background, GitHub will call <code>devtools::check()</code> on your code. This will try to (among other things),</p>
<ol type="1">
<li>rebuild and install the package,</li>
<li>build vignettes,</li>
<li>run all examples,</li>
<li>run the tests,</li>
<li>and run the standard <code>R CMD Check</code>.</li>
</ol>
<p>Then, you’ll see a Green Checkmark on the PR (or a red X on failure). This ensures that modifications that you make (or are about to make) don’t screw up your code.</p>
<p>In practice, you would check locally on a regular basis (see below). But not everyone does, and sometimes you forget. This is the (nearly) foolproof way to make sure that collaborators (and you) don’t mess something up.</p>
<p>You may think you don’t want to set this up immediately. Perhaps you haven’t implemented some key functionality, haven’t written enough tests, etc. I’d argue you should do this now anyway. This will force you (at least if you hate seeing the red X) to make every new piece of your code run. This avoids the common “I’m just going to write most of the stuff to get it running, and make sure it works later.”</p>
</section>
</section>
<section id="commands-to-issue-regularly" class="level2">
<h2 class="anchored" data-anchor-id="commands-to-issue-regularly">Commands to issue regularly</h2>
<p>These you’ll use while working on the package. Probably calling them multiple times per session.</p>
<section id="devtoolsload_all" class="level3">
<h3 class="anchored" data-anchor-id="devtoolsload_all"><code>devtools::load_all()</code></h3>
<p>This loads all functions (including unexported functions). This is different than calling <code>library(mypkg)</code>. If you want to play around with the things you’ve just written, call this. Never click <code>Source</code> or call <code>source(somefile)</code>. This causes conflicts in unpleasant ways.</p>
<p>Calling <code>devtools::load_all()</code> also loads Dependencies and rebuilds <code>src/</code> (C, Cpp, or Fortran) files if needed.</p>
</section>
<section id="devtoolsdocument" class="level3">
<h3 class="anchored" data-anchor-id="devtoolsdocument"><code>devtools::document()</code></h3>
<p>Rebuilds package documentation. The Roxygen tags are not only for help files built also control the NAMESPACE. Often, especially with S3 methods, you’ll need to do this to make sure that the NAMESPACE is exporting the right things before your methods will work.</p>
</section>
<section id="devtoolscheck" class="level3">
<h3 class="anchored" data-anchor-id="devtoolscheck"><code>devtools::check()</code></h3>
<p>This is the same as clicking <code>Check</code> on the package Build tab. See the description for the similar GitHub Action above. This just does it all locally. Do this regularly to make sure you’re not breaking things. If you are about to open a PR, be sure these pass. Any “Notes” that appear are OK for development, but generally not for CRAN.</p>
</section>
<section id="usethisuse_testname_of_function" class="level3">
<h3 class="anchored" data-anchor-id="usethisuse_testname_of_function"><code>usethis::use_test("name_of_function")</code></h3>
<p>You just wrote a function and are playing with it in the console to make sure it works. Stop. Write these permanently as tests. This command will create the appropriate file and give a skeleton test.</p>
<p>Writing good unit tests is well beyond the purpose of this document. A few rules of thumb:</p>
<ul>
<li>Ensure that all arguments are validated.</li>
<li>Try some inputs that have predictable outputs. Make sure this works.</li>
<li>Avoid random numbers.</li>
<li>Complicated functions are hard to handle. Try to break these down into smaller sub-functions.</li>
<li>Test the class of your output.</li>
<li>An ideal set of tests would examine all possible combinations of inputs. This can be a pain. But your user might call some of these, and it’d be unfortunate if something has unpredictable behaviour.</li>
<li>For errors, I suggest using <code>expect_snapshot(error = TRUE, buggy_fun(args))</code>. This writes the error message to a <code>.md</code> document to validate against. So, at minimum, code that suddenly produces a <em>different</em> error will then fail the test. Even better, you can look at the message produced and ensure that it’s reasonable.</li>
</ul>
</section>
<section id="usethisuse_tidy_description" class="level3">
<h3 class="anchored" data-anchor-id="usethisuse_tidy_description"><code>usethis::use_tidy_description()</code></h3>
<p>This just cleans up the DESCRIPTION. Alphabetizing imports, controlling spacing, a few other things. Not required, but nicer.</p>
</section>
<section id="usethisuse_vignette" class="level3">
<h3 class="anchored" data-anchor-id="usethisuse_vignette"><code>usethis::use_vignette()</code></h3>
<p>Create a vignette for long-form documentation. The YAML header is a bit strange, so this is easier than creating an empty <code>.Rmd</code> some other way.</p>
</section>
</section>
<section id="other-idiosyncracies" class="level2">
<h2 class="anchored" data-anchor-id="other-idiosyncracies">Other idiosyncracies</h2>
<ul>
<li>Functions are best named as verbs <code>estimate_something()</code>. Prefer snake case where possible.</li>
<li>There are exceptions, the most common being <code>mypkg()</code>. Especially if your package does basically one thing.</li>
<li>Try to reuse function names that other packages use for similar behaviour. An example is <code>cv.estimator()</code>. Someone who uses <code>{glmnet}</code> will then know what this is. (I might use <code>cv_estimator()</code>).</li>
<li>In general, look at other packages that are well-regarded and use similar/familiar names and behaviours. <code>{glmnet}</code> is a great example for regularized linear models. It’s well-written, widely used, and supported. So having arguments in a similar order with similar names to those will make it easier on your users.</li>
<li>Add <code>print()</code> methods for your classes.</li>
<li>Avoid piles of Imports.</li>
<li>Make good use of <code>{rlang}</code>. It helps with lots of issues.</li>
<li>Never Import <code>{tidyverse}</code>.</li>
<li>Best to have 1 function per file, with the file name the same as the name of function. The main exception is consolidating methods in one place, or putting a helper function together with the function it helps.</li>
<li>Use <code>{cli}</code> to write nice error messages.</li>
<li>Document thoroughly. This includes the rendered documentation and comments in the code. Focus on the “why”. The “what” should be intelligible to someone looking at the code. If it’s not, then refactor the code (better object names for instance).</li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/dajmcdon\.github\.io\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p><a href="https://github.com/dajmcdon"><i class="bi bi-github"></i></a> <a href="https://scholar.google.com/citations?user=qRmkt6wAAAAJ&amp;hl=en"><i class="ai ai-google-scholar"></i></a> <a href="https://www.linkedin.com/in/dajmcdon/"><i class="bi bi-linkedin"></i></a> <a href="https://orcid.org/0000-0002-0443-4282"><i class="ai ai-orcid"></i></a> <a href="mailto:daniel@stat.ubc.ca"><i class="bi bi-envelope"></i></a></p>
</div>
    <div class="nav-footer-right">
<p>© 2025 Daniel J. McDonald</p>
</div>
  </div>
</footer>




</body></html>